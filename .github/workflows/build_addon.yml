name: build addon

on:
  push:
    tags: ["*"]
    # To build on main/master branch, uncomment the following line:
    # branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Package add-on
        run: |
          python - <<'PY'
          from pathlib import Path
          import zipfile

          root = Path(".")
          manifest_path = root / "enchancedSpeechHistory" / "manifest.ini"
          manifest_text = manifest_path.read_text(encoding="utf-8")

          addon_name = None
          addon_version = None
          for line in manifest_text.splitlines():
            if line.startswith("name ="):
              addon_name = line.split('"')[1]
            elif line.startswith("version ="):
              addon_version = line.split('"')[1]

          if not addon_name or not addon_version:
            raise RuntimeError("Could not parse add-on name/version from enchancedSpeechHistory/manifest.ini")

          out_file = root / f"{addon_name}-{addon_version}.nvda-addon"
          with zipfile.ZipFile(out_file, "w", zipfile.ZIP_DEFLATED) as addon_zip:
            addon_zip.write(manifest_path, "manifest.ini")
            addon_zip.write(
              root / "enchancedSpeechHistory" / "globalPlugins" / "enchancedSpeechHistory.py",
              "globalPlugins/enchancedSpeechHistory.py",
            )
          print(f"Created {out_file}")
          PY

      - uses: actions/upload-artifact@v5
        with:
          name: packaged_addon
          path: ./*.nvda-addon

  upload_release:
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    needs: ["build"]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5
      - name: download releases files
        uses: actions/download-artifact@v6

      - name: Display structure of downloaded files
        run: ls -R

      - name: Prepare release notes and sha256
        run: |
          TAG_NO_V="${GITHUB_REF_NAME#v}"
          NOTES_FILE="release-notes-${TAG_NO_V}.md"
          if [ -f "$NOTES_FILE" ]; then
            cp "$NOTES_FILE" changelog.md
          else
            echo "# ${GITHUB_REF_NAME}" > changelog.md
            echo >> changelog.md
            echo "Automated release." >> changelog.md
          fi
          if ! ls ./*.nvda-addon >/dev/null 2>&1; then
            echo "No .nvda-addon assets found after artifact download."
            exit 1
          fi
          echo -e "\nSHA256:\n" >> changelog.md
          sha256sum ./*.nvda-addon >> changelog.md

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./*.nvda-addon
          body_path: changelog.md
          fail_on_unmatched_files: true
          prerelease: ${{ contains(github.ref, '-') }}
