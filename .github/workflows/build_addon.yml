name: build addon

on:
  push:
    tags: ["*"]
    # To build on the default branch as well, uncomment:
    # branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Package add-on
        run: |
          python - <<'PY'
          from pathlib import Path
          import zipfile

          root = Path(".")
          manifest_path = root / "enchancedSpeechHistory" / "manifest.ini"
          manifest_text = manifest_path.read_text(encoding="utf-8")

          addon_name = None
          addon_version = None
          for line in manifest_text.splitlines():
            if line.startswith("name ="):
              addon_name = line.split('"')[1]
            elif line.startswith("version ="):
              addon_version = line.split('"')[1]

          if not addon_name or not addon_version:
            raise RuntimeError("Could not parse add-on name/version from enchancedSpeechHistory/manifest.ini")

          out_file = root / f"{addon_name}-{addon_version}.nvda-addon"
          with zipfile.ZipFile(out_file, "w", zipfile.ZIP_DEFLATED) as addon_zip:
            addon_zip.write(manifest_path, "manifest.ini")
            addon_zip.write(
              root / "enchancedSpeechHistory" / "globalPlugins" / "enchancedSpeechHistory.py",
              "globalPlugins/enchancedSpeechHistory.py",
            )
          print(f"Created {out_file}")
          PY

      - uses: actions/upload-artifact@v5
        with:
          name: packaged_addon
          path: ./*.nvda-addon

  upload_release:
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    needs: ["build"]
    permissions:
      contents: write
    steps:
      - name: download releases files
        uses: actions/download-artifact@v6

      - name: Display structure of downloaded files
        run: ls -R

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            packaged_addon/*.nvda-addon
          fail_on_unmatched_files: true
          prerelease: ${{ contains(github.ref, '-') }}
